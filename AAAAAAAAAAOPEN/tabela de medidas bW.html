<!-- ===== Estilo ===== -->
<style>
  .modal-medidas {
    text-align: left;
  }
  .modal-medidas .swal2-title {
    display: none !important;
  }
  .modal-medidas .swal2-html-container {
    margin: 0 !important;
    padding: 10px !important;
  }

  /* GRID DESKTOP: 2 colunas (imagem | medidas). No mobile vira 1 coluna */
  .mm-grid {
    display: grid;
    gap: 16px;
    align-items: start;
    grid-template-columns: 1fr 1.2fr;
    padding: 0 10px 10px;
  }
  @media (max-width: 768px) {
    .mm-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Wrapper da imagem para permitir overlay das medidas no desktop */
  .mm-hero-wrap {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: #f7f7f7;
  }
  .mm-hero {
    width: 100%;
    aspect-ratio: 3/4;
    display: block;
    overflow: hidden;
  }
  .mm-hero img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* —— MEDIDAS DA MODELO (overlay à direita no desktop) —— */
  /* ---- Medidas da modelo: só texto no canto inferior direito ---- */
  .mm-modelo-float {
    position: absolute;
    right: 14px;
    bottom: 14px;
    transform: none;
    background: transparent;
    border: none;
    padding: 0;
    width: auto;
    max-width: 45%;
    color: #fff; /* texto branco sobre a foto */
    text-align: right;
    pointer-events: none; /* não bloqueia clique/zoom na imagem */
  }

  /* títulos e linhas de medida */
  .mm-modelo-title {
    margin: 0 0 6px;
    font-size: 12px;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    /* leve contorno para legibilidade */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.55), 0 0 1px rgba(0, 0, 0, 0.35);
  }
  .mm-modelo-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 6px;
  }
  .mm-modelo-item {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    font-size: 13px;
    line-height: 1.2;
  }
  .mm-modelo-item .k {
    font-weight: 700;
  }
  .mm-modelo-item .v {
    opacity: 0.95;
  }

  /* reforça a leitura do texto sobre fundos claros */
  .mm-modelo-item .k,
  .mm-modelo-item .v {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.55), 0 0 1px rgba(0, 0, 0, 0.35);
  }

  /* Mobile: vira bloco abaixo da imagem, cor escura e sem sombra */
  @media (max-width: 768px) {
    .mm-modelo-title,
    .mm-modelo-item .k,
    .mm-modelo-item .v {
      text-align: end;
    }
  }

  /* Abas */
  .mm-tabs {
    display: flex;
    gap: 8px;
    padding: 10px 0;
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
    border-bottom: 1px solid #eee;
  }
  .mm-tab {
    appearance: none;
    border: 1px solid #e6e6e6;
    background: #fff;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: 14px;
    cursor: pointer;
  }
  .mm-tab.is-active {
    border-color: #222;
    font-weight: 600;
  }

  /* Cards (usados no mobile e no desktop) */
  .cards-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    padding: 10px 0;
  }
  @media (min-width: 1024px) {
    .cards-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  .mm-card {
    border: 1px solid #eee;
    border-radius: 14px;
    padding: 12px;
    background: #fff;
  }
  .mm-card h4 {
    margin: 0 0 8px;
    font-size: 15px;
  }
  .mm-dl {
    margin: 0;
  }
  .mm-dl .row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px dashed #f0f0f0;
    font-size: 14px;
  }
  .mm-dl .row:last-child {
    border-bottom: none;
  }
  .mm-dl .k {
    font-weight: 600;
    color: #333;
  }
  .mm-dl .v {
    color: #555;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // <![CDATA[
  $(function () {
    /* ========================
     * DADOS DAS MEDIDAS
     * ======================== */
    const MEASURES = {
      Legging: {
        order: ["Cintura", "Quadril", "Comprimento", "Manequim"],
        sizes: ["P", "M", "G", "GG"],
        rows: {
          Cintura: { P: "65", M: "72", G: "81", GG: "89" },
          Quadril: { P: "91", M: "98", G: "107", GG: "115" },
          Comprimento: { P: "90", M: "92", G: "94", GG: "96" },
          Manequim: { P: "36/38", M: "38/40", G: "42/44", GG: "46/48" },
        },
        unit: { Cintura: "cm", Quadril: "cm", Comprimento: "cm" },
      },
      Short: {
        order: ["Cintura", "Quadril", "Comprimento", "Manequim"],
        sizes: ["P", "M", "G", "GG"],
        rows: {
          Cintura: { P: "65", M: "72", G: "81", GG: "89" },
          Quadril: { P: "91", M: "98", G: "107", GG: "115" },
          Comprimento: { P: "38", M: "40", G: "42", GG: "44" },
          Manequim: { P: "36/38", M: "38/40", G: "42/44", GG: "46/48" },
        },
        unit: { Cintura: "cm", Quadril: "cm", Comprimento: "cm" },
      },
      "Top Nadador": {
        order: ["Cintura", "Busto", "Comprimento", "Manequim"],
        sizes: ["P", "M", "G", "GG"],
        rows: {
          Cintura: { P: "65", M: "72", G: "81", GG: "89" },
          Busto: { P: "80", M: "88", G: "98", GG: "107" },
          Comprimento: { P: "30", M: "32", G: "34", GG: "36" },
          Manequim: { P: "36/38", M: "38/40", G: "42/44", GG: "46/48" },
        },
        unit: { Cintura: "cm", Busto: "cm", Comprimento: "cm" },
      },
      "Top Alcinha": {
        order: ["Cintura", "Busto", "Comprimento", "Manequim"],
        sizes: ["P", "M", "G", "GG"],
        rows: {
          Cintura: { P: "65", M: "72", G: "81", GG: "89" },
          Busto: { P: "74", M: "82", G: "92", GG: "101" },
          Comprimento: { P: "26", M: "27", G: "28", GG: "29" },
          Manequim: { P: "36/38", M: "38/40", G: "42/44", GG: "46/48" },
        },
        unit: { Cintura: "cm", Busto: "cm", Comprimento: "cm" },
      },
    };

    /* ========================
     * CONFIG
     * ======================== */
    const PRODUCT_TITLE_SELECTORS = [
      ".informacoes-compra-produto > h1",
      ".informacoes-compra-produto h1",
      ".product-title h1",
      "h1.product-title",
      "h1.product-name",
      ".product-name",
      ".prd-title",
      "h1.titulo",
      "h1",
    ];
    const SIZE_ORDER = ["PP", "P", "M", "G", "GG", "Único"];
    const stripAcc = (s) =>
      (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const norm = (s) =>
      stripAcc(
        String(s || "")
          .toLowerCase()
          .trim()
      );
    const isMobile = () => window.matchMedia("(max-width: 768px)").matches;

    function getProductTitle() {
      for (const sel of PRODUCT_TITLE_SELECTORS) {
        const t = $(sel).first().text().trim();
        if (t) return t;
      }
      return $('meta[property="og:title"]').attr("content") || "";
    }

    /* ========================
     * DETECTAR CATEGORIAS
     * ======================== */
    function detectCategoriesByName(nameRaw) {
      const name = norm(nameRaw);
      const hasLegging = /\blegg?ing\b/.test(name);
      const hasShort = /\bshorts?\b/.test(name);
      const isConjunto = /\bconjunto\b/.test(name);
      const topIsNadador = /\bnadador(a)?\b/.test(name);
      const topIsAlca = /\balcinha\b|\balca\b|\bde alca\b/.test(name);
      const allow = new Set();

      if (!isConjunto) {
        if (hasLegging) allow.add("Legging");
        if (hasShort) allow.add("Short");
        if (/\btop\b/.test(name)) {
          if (topIsNadador) allow.add("Top Nadador");
          if (topIsAlca) allow.add("Top Alcinha");
          if (!topIsNadador && !topIsAlca) {
            allow.add("Top Nadador");
            allow.add("Top Alcinha");
          }
        }
        if (!allow.size) Object.keys(MEASURES).forEach((c) => allow.add(c));
        return Array.from(allow);
      }
      if (hasLegging) allow.add("Legging");
      if (hasShort) allow.add("Short");
      if (!hasLegging && !hasShort) {
        allow.add("Legging");
        allow.add("Short");
      }
      if (topIsNadador) allow.add("Top Nadador");
      if (topIsAlca) allow.add("Top Alcinha");
      if (!topIsNadador && !topIsAlca) {
        allow.add("Top Nadador");
        allow.add("Top Alcinha");
      }
      return Array.from(allow);
    }

    function orderCats(cats) {
      const order = ["Legging", "Short", "Top Nadador", "Top Alcinha"];
      return cats.slice().sort((a, b) => order.indexOf(a) - order.indexOf(b));
    }

    /* ========================
     * RENDER COMPONENTES
     * ======================== */
    function renderHeroWrap() {
      const $img = $(".gallery-main img").first();
      const src = $img.attr("data-src") || $img.attr("src") || "";
      let lis = "";
      $(".medidas-modelo .infoModelo > div").each(function () {
        lis += `<li class="mm-modelo-item"><span class="k">${(
          $(this).data("atributo") || ""
        ).toUpperCase()}</span><span class="v">${$(this).text()}</span></li>`;
      });
      return `
      <div class="mm-hero-wrap">
        <div class="mm-hero">${
          src ? `<img src="${src}" alt="Modelo">` : ``
        }</div>
        <div class="mm-modelo-float">
          <div class="mm-modelo-title">Modelo veste P</div>
          <ul class="mm-modelo-list">${lis}</ul>
        </div>
      </div>
    `;
    }

    function renderCards(cat) {
      const m = MEASURES[cat];
      if (!m) return "";
      const sizes = (m.sizes || [])
        .slice()
        .sort((a, b) => SIZE_ORDER.indexOf(a) - SIZE_ORDER.indexOf(b));
      let html = '<div class="cards-grid">';
      sizes.forEach((tam) => {
        html += `<div class="mm-card"><h4>Tamanho ${tam}</h4><div class="mm-dl">`;
        m.order.forEach((attr) => {
          const val = (m.rows[attr] || {})[tam] ?? "—";
          const unit = m.unit && m.unit[attr] ? ` ${m.unit[attr]}` : "";
          html += `<div class="row"><span class="k">${attr}</span><span class="v">${val}${unit}</span></div>`;
        });
        html += `</div></div>`;
      });
      html += "</div>";
      return html;
    }

    function tabs(categorias, atual) {
      if (categorias.length <= 1) return "";
      return `
      <div class="mm-tabs">
        ${categorias
          .map(
            (c) => `
          <button class="mm-tab ${
            c === atual ? "is-active" : ""
          }" data-tab="${c}">
            ${c}
          </button>`
          )
          .join("")}
      </div>`;
    }

    /* ========================
     * INSERIR BOTÃO AUTOMATICAMENTE APÓS .area-derivacoes
     * ======================== */
    function ensureButtonExists() {
      if ($(".ver-tabela-de-medidas").length) return;

      const btnHtml = `
    <div id="button-measure-table" class="mt-space-16">
      <div class="mt-space-20 flex items-center p-[6px]">
        <button type="button" role="button" tabindex="0"
          class="ver-tabela-de-medidas flex w-fit items-center gap-space-8 rounded-sm border border-solid border-secondary-100 p-space-8"
          style="cursor:pointer; pointer-events:auto;">
          <img src="https://public-resources.cdn.magazord.com.br/assets/global/common-icons/commerce/icon-ruler.svg" width="18" height="17" alt="Tabela de medidas" title="Tabela de medidas">
          <span class="text text-xs text-secondary-800">Tabela de medidas</span>
        </button>
      </div>
    </div>`;

      if ($(".area-derivacoes").length) {
        $(".area-derivacoes").last().after(btnHtml);
      } else if ($("#content-price-product").length) {
        $("#content-price-product").after(btnHtml);
      } else if ($(".informacoes-compra-produto").length) {
        $(".informacoes-compra-produto").append(btnHtml);
      } else {
        $("body").append(btnHtml);
      }
    }

    /* ========================
     * MODAL
     * ======================== */
    function openMeasureModal() {
      const productTitle = getProductTitle();
      const allow = detectCategoriesByName(productTitle);
      let categorias = Object.keys(MEASURES).filter((c) => allow.includes(c));
      if (!categorias.length) categorias = Object.keys(MEASURES);
      const categoriasFinal = orderCats(categorias);
      let catAtual = categoriasFinal[0];

      function layout() {
        const hero = renderHeroWrap();
        const tbs = tabs(categoriasFinal, catAtual);
        const cards = renderCards(catAtual);
        if (isMobile()) return `${hero}${tbs}${cards}`;
        return `<div class="mm-grid"><div class="mm-col">${hero}</div><div class="mm-col">${tbs}${cards}</div></div>`;
      }

      Swal.fire({
        html: layout(),
        showCloseButton: true,
        showConfirmButton: false,
        width: "min(92vw, 1000px)",
        background: "#fff",
        customClass: { popup: "modal-medidas" },
        didRender: () => {
          $(".mm-tab")
            .off("click")
            .on("click", function () {
              catAtual = $(this).data("tab");
              $(".swal2-html-container").html(layout());
              $(".mm-tab").off("click").on("click", arguments.callee);
            });
        },
      });
    }

    $(document).on("click", ".ver-tabela-de-medidas", function (e) {
      e.preventDefault();
      if (typeof Swal === "undefined") {
        $.getScript(
          "https://cdn.jsdelivr.net/npm/sweetalert2@11",
          openMeasureModal
        );
      } else {
        openMeasureModal();
      }
    });

    // cria o botão se não existir
    ensureButtonExists();
  });
  // ]]>
</script>
