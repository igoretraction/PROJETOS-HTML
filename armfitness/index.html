<script>
  document.addEventListener("DOMContentLoaded", function () {
    const TARGET_SELECTOR_PRIMARY = ".topo-produto";
    const TARGET_SELECTOR_FALLBACK = "#pagina-produto-react-app";

    /* ================== CONFIG ================== */
    // Principal com seleção de tamanho (usa SKUs filhos)
    const MAIN_PRODUCT = {
      id: "main-top",
      sku: "L01PT", // base
      name: "Legging preta",
      color: "Preto",
      sizes: [["P", "M", "G"]],
      qty: 1,
      img: "https://armfitness.cdn.magazord.com.br/img/2025/06/produto/3409/lookbook-arm-fitness-27-036944.jpg?ims=635x865",
    };
    const mainColors = []; // [] = sem swatches de cor pro principal

    // Recomendados
    const RECO_ITEMS = [
      {
        id: "top",
        skuBase: "T08PT",
        name: "Top esportivo",
        priceNow: "R$ 59,00",
        priceWas: "R$ 69,00",
        badge: "Mais vendido",
        img: "https://armfitness.cdn.magazord.com.br/img/2022/11/produto/1539/arm-fitness2679.jpg?ims=635x865",
        colors: ["Preto", "Grafite", "Cinza"],
        sizes: [["P", "M", "G"]],
        comboSizes: 1,
      },
      {
        id: "camiseta-uv",
        // cor é escolhida por swatch; base muda por cor
        skuBase: "1FC06CML122", // (default: Preto)
        name: "Camiseta Manga Longa Proteção UV",
        priceNow: "R$ 59,00",
        badge: "Novo",
        img: "https://armfitness.cdn.magazord.com.br/img/2025/07/produto/3610/arm0430.jpg?ims=635x865",
        colors: ["Preto", "Verde Água", "Azul Bebê"],
        sizes: [["P", "M", "G"]],
        comboSizes: 1,
      },
      {
        id: "meias",
        skuBase: "1FC06CML132",
        name: "Meias técnicas",
        priceNow: "R$ 169,90",
        img: "https://armfitness.cdn.magazord.com.br/img/2025/07/produto/3683/kit-meias-teste6-3.jpg?ims=635x865",
        colors: [],
        sizes: [[]],
        comboSizes: 0,
      },
    ];

    // Regras explícitas de resolução de SKU filho
    const SKU_RULES = {
      // principal
      "main-top": {
        type: "sizeMap",
        childBySize: { P: "T08PT-P", M: "T08PT-M", G: "T08PT-G" },
      },
      // itens
      top: {
        type: "sizeMap",
        childBySize: { P: "T08PT-P", M: "T08PT-M", G: "T08PT-G" },
      },
      "camiseta-uv": {
        type: "colorBasePlusSize",
        baseByColor: {
          Preto: "1FC06CML122",
          "Verde Água": "1FC06CML125",
          "Azul Bebê": "1FC06CML126",
        },
        sizeSuffix: { P: "-P", M: "-M", G: "-G" },
      },
      meias: {
        type: "fixed",
        fixedSku: "1FC06CML132-preto",
      },
    };
    /* ============================================ */

    const target =
      document.querySelector(TARGET_SELECTOR_PRIMARY) ||
      document.querySelector(TARGET_SELECTOR_FALLBACK);
    if (!target) return;

    // Styles (corrige radios clicáveis)
    if (!document.getElementById("cl-styles")) {
      const style = document.createElement("style");
      style.id = "cl-styles";
      style.textContent = `
    :root{
      --bg:#fff; --bg-soft:#f6f7f8; --txt:#111; --muted:#666; --line:#e9ecef;
      --accent:#111; --radius:16px; --shadow:0 4px 20px rgba(0,0,0,.06);
      --container:1100px;
    }
    *{box-sizing:border-box}
    img{display:block;max-width:100%;height:auto}
    .sr-only{position:absolute;width:1px;height:1px;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .complete-look{max-width:var(--container);margin:0 auto;padding:clamp(16px,3vw,28px) 16px}
    .cl-header h3{margin:0 0 4px;font-size:clamp(20px,2.4vw,28px)}
    .cl-header p{margin:0;color:var(--muted)}
    .cl-wrapper{margin-top:20px;display:grid;grid-template-columns:minmax(280px,360px) 1fr;gap:24px}
    @media (max-width:860px){.cl-wrapper{grid-template-columns:1fr}}
    .main-card{background:var(--bg-soft);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .main-media{aspect-ratio:3/4;width:100%;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
    .main-media img{width:100%;height:100%;object-fit:contain;background:#fff}
    .main-title{margin:12px 0 6px;font-size:18px}
    .main-meta{margin:0;color:var(--muted)}
    .reco{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .reco-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:1024px){.reco-row{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){
      .reco-row{grid-auto-flow:column;grid-auto-columns:85%;overflow-x:auto;gap:12px;scroll-snap-type:x mandatory;padding-bottom:6px}
      .card{scroll-snap-align:start}
    }
    .card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:var(--bg);display:flex;flex-direction:column;min-height:100%}
    .card-media{position:relative;background:var(--bg-soft);aspect-ratio:1/1}
    .card-media img{width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;top:10px;left:10px;background:#fff;border:1px solid var(--line);padding:6px 8px;border-radius:999px;font-size:12px;box-shadow:var(--shadow)}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:10px}
    .card h4{margin:0;font-size:16px;line-height:1.3}
    .price{display:flex;gap:8px;align-items:baseline}
    .price .now{font-weight:600}
    .price .was{color:var(--muted);text-decoration:line-through}
    .swatches,.sizes{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .swatches input,.sizes input{position:absolute;opacity:0;width:0;height:0} /* <<< radios clicáveis */
    .swatches label.swatch{--size:22px;width:var(--size);height:var(--size);border-radius:50%;border:1px solid #d0d7de;display:inline-block;cursor:pointer;transition:transform .15s, box-shadow .15s, border-color .15s;background:var(--sw,#111);position:relative;z-index:1}
    .swatches label.swatch:hover{box-shadow:0 0 0 4px rgba(0,0,0,.06)}
    .swatches input:checked + label.swatch{outline:2px solid var(--accent);outline-offset:2px;transform:scale(1.05)}
    .sizes label.chip{border:1px solid var(--line);padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;transition:background .15s,color .15s,border-color .15s,transform .12s;user-select:none;position:relative;z-index:1}
    .sizes label.chip:hover{border-color:var(--accent);transform:translateY(-1px)}
    .sizes input:checked + label.chip{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 6px 14px rgba(0,0,0,.12)}
    .qty{display:flex;align-items:center;gap:8px}
    .qty input[type="number"]{width:56px;padding:6px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .btn{padding: 5px; appearance:none;border:1px solid var(--txt);background:var(--txt);color:#fff;padding:12px 18px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .12s, box-shadow .15s}
    .btn.secondary{background:#fff;color:var(--txt)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .btn-mini{border:1px solid var(--txt);background:#fff;color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-mini.selected{background:var(--accent);color:#fff}
    .btn-mini.selected::before{content:"✓ ";font-weight:700}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;border-top:1px solid var(--line);padding:16px 12px 0;margin-top:8px;color:var(--muted);flex-wrap:wrap}
    .save{color:var(--txt)}
    .summary{font-size:14px;color:var(--muted)}
    @media (max-width:640px){
      .footer{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(255,255,255,0) 0%, #fff 28%);padding:12px;margin:0;border:none}
      .footer .actions{display:flex;gap:8px;width:100%}
      .footer .actions .btn{flex:1}
    }`;
      document.head.appendChild(style);
    }

    // Helpers UI
    const COLOR_HEX = {
      Preto: "#111",
      Branco: "#fff",
      Grafite: "#777",
      Cinza: "#bdbdbd",
      Azul: "#2980b9",
      "Azul Bebê": "#b3d9ff",
      "Verde Água": "#00b894",
      Bege: "#d9c2a1",
    };

    const renderSwatches = (colors = [], groupName) => {
      if (!colors.length) return "";
      const radios = colors
        .map((c, idx) => {
          const id = `${groupName}-cor-${idx}`;
          const sw = COLOR_HEX[c] || "#111";
          const checked = idx === 0 ? "checked" : "";
          return `
        <input type="radio" id="${id}" name="${groupName}-cor" ${checked}>
        <label for="${id}" class="swatch" style="--sw:${sw}" title="${c}"></label>
      `;
        })
        .join("");
      return `<div class="swatches" aria-label="Cores">${radios}</div>`;
    };

    const renderSizes = (sizes = [[]], groupName, comboSizes = 0) => {
      if (!comboSizes) return "";
      const buildGroup = (opts, slotIdx) => {
        const name = `${groupName}-size-${slotIdx + 1}`;
        const chips = (opts || [])
          .map((s, idx) => {
            const id = `${name}-${s}`;
            const checked =
              idx === 1 || (idx === 0 && opts.length === 1) ? "checked" : ""; // default M
            return `<input type="radio" id="${id}" name="${name}" ${checked}><label class="chip" for="${id}">${s}</label>`;
          })
          .join("");
        return `<div class="sizes" aria-label="Tamanhos" data-slot="${
          slotIdx + 1
        }">${chips}</div>`;
      };
      return buildGroup(sizes[0] || [], 0);
    };

    // Monta cards
    const cardsHTML = RECO_ITEMS.map((it, idx) => {
      const g = `g${idx + 1}`;
      const priceWas = it.priceWas
        ? `<span class="was">${it.priceWas}</span>`
        : "";
      const badge = it.badge ? `<span class="badge">${it.badge}</span>` : "";
      return `
      <article class="card" role="listitem"
               data-item-id="${it.id}"
               data-sku-base="${it.skuBase}" data-nome="${
        it.name
      }" data-selected="false"
               data-combo-sizes="${Number(it.comboSizes || 0)}">
        <div class="card-media">
          <img src="${it.img}" alt="${it.name}">
          ${badge}
        </div>
        <div class="card-body">
          <h4>${it.name}</h4>
          <div class="price"><span class="now">${
            it.priceNow
          }</span>${priceWas}</div>
          ${renderSwatches(it.colors, g)}
          ${renderSizes(it.sizes, g, it.comboSizes)}
          <div class="qty">
            <label class="sr-only" for="qty-${g}">Quantidade</label>
            <input id="qty-${g}" type="number" min="1" value="1" inputmode="numeric">
          </div>
          <button class="btn-mini add-btn" type="button">Adicionar</button>
        </div>
      </article>
    `;
    }).join("");

    const mainSizesHTML = renderSizes(MAIN_PRODUCT.sizes, "main", 1);
    const mainSwatchesHTML = renderSwatches(mainColors, "main");

    const html = `
    <main class="complete-look" aria-labelledby="complete-look-title">
      <div class="cl-header">
        <h3 id="complete-look-title">Complete o look</h3>
        <p>Combine e economize</p>
      </div>
      <div class="cl-wrapper">
        <aside class="main-card" aria-label="Produto principal"
               data-item-id="${MAIN_PRODUCT.id}"
               data-sku-base="${MAIN_PRODUCT.sku}" data-nome="${
      MAIN_PRODUCT.name
    }"
               data-cor="${MAIN_PRODUCT.color || ""}"
               data-qty="${Math.max(1, parseInt(MAIN_PRODUCT.qty || 1, 10))}">
          <div class="main-media"><img src="${MAIN_PRODUCT.img}" alt="${
      MAIN_PRODUCT.name
    }"></div>
          <h2 class="main-title">${MAIN_PRODUCT.name}</h2>
          <div class="card-body">
            ${mainSwatchesHTML}
            ${mainSizesHTML}
            <p class="main-meta">Cor padrão: ${MAIN_PRODUCT.color || "-"}</p>
          </div>
        </aside>

        <section class="reco" aria-label="Compre Junto">
          <div class="reco-row" role="list">${cardsHTML}</div>
          <div class="footer" aria-live="polite">
            <div class="controls">
              <label><input id="matchColor" type="checkbox" checked> Combinar minha cor</label>
              <span class="save">Você economiza <strong>R$ 20,00</strong></span>
              <span class="summary" id="summary">Selecionados: 0</span>
            </div>
            <div class="actions">
              <button class="btn" id="addAllBtn" type="button">Adicionar ao carrinho</button>
            </div>
          </div>
        </section>
      </div>
    </main>`;
    target.insertAdjacentHTML("afterend", html);

    /* ================== JS ================== */
    const q = (sel, ctx = document) => ctx.querySelector(sel);
    const qa = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    function getSelections(card) {
      const combo = Number(card?.dataset?.comboSizes || 0);
      let s1 = null,
        s2 = null;
      if (combo >= 1)
        s1 =
          card
            .querySelector('.sizes[data-slot="1"] input:checked + label')
            ?.textContent?.trim() || null;
      if (combo >= 2)
        s2 =
          card
            .querySelector('.sizes[data-slot="2"] input:checked + label')
            ?.textContent?.trim() || null;
      const colorLabel =
        card
          .querySelector(".swatches input:checked + label")
          ?.getAttribute("title") || null;
      const qty = parseInt(card.querySelector(".qty input")?.value || "1", 10);
      return {
        s1,
        s2,
        color: colorLabel,
        qty: isNaN(qty) || qty < 1 ? 1 : qty,
      };
    }
    function getMainSelections() {
      const mainEl = q(".main-card");
      const s1 =
        q(
          '.main-card .sizes[data-slot="1"] input:checked + label'
        )?.textContent?.trim() || null;
      const color =
        q(".main-card .swatches input:checked + label")?.getAttribute(
          "title"
        ) ||
        mainEl.dataset.cor ||
        null;
      const qty = Math.max(1, parseInt(mainEl.dataset.qty || "1", 10));
      return { s1, color, qty };
    }

    // Resolve SKU por regras
    function resolveSkuByRule(rule, sel, fallbackBase) {
      if (!rule) return fallbackBase; // fallback
      if (rule.type === "sizeMap") {
        return rule.childBySize?.[sel.s1] || fallbackBase;
      }
      if (rule.type === "colorBasePlusSize") {
        const base = rule.baseByColor?.[sel.color] || fallbackBase;
        const suf = rule.sizeSuffix?.[sel.s1] || "";
        return base + suf;
      }
      if (rule.type === "fixed") {
        return rule.fixedSku;
      }
      return fallbackBase;
    }

    // >>>> GARANTE QUANTIDADE EXATA <<<<
    function addToCartMagazord(sku, quantity, callback) {
      const co = window.Zord?.checkout;
      const q = Math.max(1, parseInt(quantity, 10) || 1);

      try {
        if (!co) {
          if (typeof callback === "function") callback(false);
          return;
        }

        // Usa método nativo de quantidade se existir
        if (typeof co.addCartQtd === "function") {
          co.addCartQtd(sku, q, 1, 0, function () {
            co.atualizaQuantidadeEspecificaCarrinho?.();
            if (typeof callback === "function") callback(true);
          });
          return;
        }
        if (typeof co.addCartComQuantidade === "function") {
          co.addCartComQuantidade(sku, q, function () {
            co.atualizaQuantidadeEspecificaCarrinho?.();
            if (typeof callback === "function") callback(true);
          });
          return;
        }

        // Fallback: adiciona 1 repetidamente até atingir q
        let left = q;
        const addOne = () => {
          co.addCart(sku, 1, 1, 0, function () {
            left--;
            if (left > 0) {
              addOne();
            } else {
              co.atualizaQuantidadeEspecificaCarrinho?.();
              if (typeof callback === "function") callback(true);
            }
          });
        };
        addOne();
      } catch (e) {
        if (typeof callback === "function") callback(false);
      }
    }

    function openCartPopupSafe() {
      if (window.Zord?.checkout?.openCartPopup) Zord.checkout.openCartPopup();
      else if (window.Zord?.cart?.openPopup) Zord.cart.openPopup();
      else window.location.href = "/checkout/cart";
    }

    const cards = qa(".reco .card");
    const summary = document.getElementById("summary");
    const addAllBtn = document.getElementById("addAllBtn");
    const matchColor = document.getElementById("matchColor");

    function updateSummary() {
      const count = cards.filter((c) => c.dataset.selected === "true").length;
      summary.textContent = `Selecionados: ${count}`;
      addAllBtn.textContent =
        count > 0
          ? `Adicionar ao carrinho (${count + 1})`
          : "Adicionar ao carrinho";
    }

    qa(".add-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const card = e.currentTarget.closest(".card");
        const selected = card.dataset.selected === "true";
        card.dataset.selected = String(!selected);
        btn.classList.toggle("selected", !selected);
        btn.textContent = !selected ? "Selecionado" : "Adicionar";
        updateSummary();
      });
    });

    function resetCardSelection(card) {
      if (!card) return;
      card.dataset.selected = "false";
      const btn = card.querySelector(".add-btn");
      if (btn) {
        btn.classList.remove("selected");
        btn.textContent = "Adicionar";
      }
      updateSummary();
    }
    qa(".sizes input, .swatches input").forEach((el) => {
      el.addEventListener("change", (e) =>
        resetCardSelection(e.target.closest(".card"))
      );
    });
    // robustez: clique no label dispara change
    qa(".sizes label.chip, .swatches label.swatch").forEach((lab) => {
      lab.addEventListener("click", () => {
        const id = lab.getAttribute("for");
        const inp = id ? document.getElementById(id) : null;
        if (inp) {
          inp.checked = true;
          inp.dispatchEvent(new Event("change", { bubbles: true }));
        }
      });
    });
    qa('.qty input[type="number"]').forEach((el) => {
      const normalize = (input) => {
        let v = parseInt(input.value || "1", 10);
        if (isNaN(v) || v < 1) v = 1;
        input.value = v;
      };
      el.addEventListener("input", (e) => {
        normalize(e.target);
        resetCardSelection(e.target.closest(".card"));
      });
      el.addEventListener("change", (e) => {
        normalize(e.target);
        resetCardSelection(e.target.closest(".card"));
      });
    });

    // CTA principal
    addAllBtn.addEventListener("click", () => {
      const mainEl = q(".main-card");
      const mainSel = getMainSelections();
      const mainRule =
        SKU_RULES[mainEl.dataset.itemId || MAIN_PRODUCT.id] ||
        SKU_RULES[MAIN_PRODUCT.id];
      const mainSku = resolveSkuByRule(
        mainRule,
        mainSel,
        mainEl.dataset.skuBase
      );

      const all = [
        { sku: mainSku, name: mainEl.dataset.nome, qty: mainSel.qty },
      ];

      const selectedCards = qa('.card[data-selected="true"]');
      selectedCards.forEach((card) => {
        const sel = getSelections(card);

        // "Combinar minha cor": só se o card tem swatch de cor
        if (matchColor?.checked && !sel.color) {
          const mainColor = mainSel.color || mainEl.dataset.cor || null;
          if (mainColor && card.querySelector(".swatches"))
            sel.color = mainColor;
        }

        const id = card.dataset.itemId;
        const rule = SKU_RULES[id];
        const skuBase = card.dataset.skuBase;
        const childSku = resolveSkuByRule(rule, sel, skuBase);

        all.push({ sku: childSku, name: card.dataset.nome, qty: sel.qty });
      });

      // Add sequencial e abre popup
      let done = 0,
        total = all.length;
      const next = () => {
        if (done >= total) return openCartPopupSafe();
        const it = all[done];
        addToCartMagazord(it.sku, it.qty, () => {
          done++;
          done === total ? openCartPopupSafe() : next();
        });
      };
      next();
    });

    updateSummary();
  });
</script>
